<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BoWu_Bidding</title>
  <!-- Link Swiper's CSS -->
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
  <link rel="stylesheet" href="./assets/css/all.css" />
  <link rel="stylesheet" href='./assets/css/pages/signin.css'>
  <link rel="stylesheet" href="./assets/css/pages/bidding.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.js"></script>
  <script src="./assets/js/jquery-3.5.1.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"></script>
  <!-- google -->
  <!-- <meta name="google-signin-scope" content="profile email"> -->
  <meta name="google-signin-client_id" content="5123688312-hh38n162r8fqfrd31n2a2hid0q7pk7uf.apps.googleusercontent.com">
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <!-- google -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
</head>
<body>
  @@include('./compontents/head.html')
  <div id="app_bidd">
  <div class="rightBlock block">
    <div class="title">
      <h1>競標展品 Bidding</h1>
      <div></div>
      <h2>Buy the goods you like!</h2>
      <p>Enjoy your bidding time.</p>
    </div>
    <div class="swiper-container">
      <button class="swiper-button-prev"></button>
      <!-- <button class="slider_prev" @click="change(active-1)">
        <img src="./assets/img/Icon ionic-ios-arrow-forward.png">
      </button> -->
      <ul class="swiper-wrapper">
        <li class="swiper-slide" v-for="(src,index) in imgList">
          <img :data-id="dataId[index]" :src="src" @click="getData">
        </li>
      </ul>
      <!-- <ul class="swiper-wrapper">
        <li class="swiper-slide" v-for="(src,index) in imgList" v-show="index == active">
          <img :data-id="dataId[index]" :src="src" @click="getData">
        </li>
      </ul> -->
      <button class="swiper-button-next"></button>
      <!-- <button class="slider_next" @click="change(active+1)">
        <img src="./assets/img/Icon ionic-ios-arrow-forward1.png">
      </button> -->
    </div>
    <div class="bidding">
      <div>競標狀態:
        <span>{{itemMessage}}</span>
      </div>
      <!-- theid原本是1 -->
      <div>競標時間: 
        <span v-if="theId == 0">{{ timer | hoursMinutesAndSeconds }}</span>
        <span v-else>{{itemTime}}</span>
      </div>
    </div>
    <div class="introduce">
      <div class="introLeft">
        <h3>競標物品</h3>
        <div class="intro">
          <div class="pic">
            <!-- <img src="./assets/img/exh_5.jpg" alt=""> -->
            <img :src="imgSrc">
          </div>
          <div class="text">
            <h3>{{ExhibitName}}</h3>
            <p>{{ExhibitIntro}}</p>
            <div class="start">
              起始價格: <span> {{Sprice}}</span>
            </div>
            <div class="current">
              目前價格: <span>{{Nprice}}</span>
            </div>
            <div class="yourPrice">
              <div>您的出價:</div>
              <div class="price">
                <button @click="inputprice -= 1"><img src="./assets/img/-.png"></button>
                <!-- <input :value="Nprice"> -->
                <input :value="inputprice">
                <button @click="inputprice += 1"><img src="./assets/img/+.png"></button>
              </div>
            </div>
            <button class="btn_button" @click=addLocal>我要競標</button>
          </div>
        </div>
      </div>
      <div class="introRight">
        <div class="top">
          <div   :class="{black:componentChange==0}"  @click="content='my-component'">討論區</div>
          <div   :class="{black:componentChange==1}" @click="content='my-component1'">競標紀錄</div>
        </div>
        <component @component_change="changeHandler" :list="newObj"  key='newObj' :is="content"></component>
      </div>
    </div>
  </div>
  </div>
  @@include('./compontents/searchbar.html')
  @@include('./compontents/music.html')
  @@include('./compontents/footer.html')
<!-- vue -->
  <script>
    const OneHour = 60 * 60 ;  //一小時的總秒數
    Vue.component('my-component',{
    template:`
    <div class="content">
          <ul class='messageform' >
            <li v-for="message in MessageData">
              <h1>{{message.user}}</h1> 
              <div class="personal">
                <img :src="message.photo">
                <p>{{message.messages}}</p>
              </div>
            </li>
          </ul>
          <div class="messageblock">
              <textarea v-model="newMessage"></textarea>
              <button @click="addmessage">傳送</button>
          </div>
        </div>
    `,
    data(){
      return{
        componentChange:'',
        MessageData:[],
        // username:'',
        newMessage:'',
        messages:[],
        nowMessagebord:{
            user:'way',
            photo:'./assets/img/Ellipse 77.png',
            messages:'',
          },
      }
    },
    mounted(){
      this.$emit('component_change',0)
      // this.componentChange == '0' ;

            //留言板格式
            // <li>
            //   <p>Andy</p>
            //   <div class="personal">
            //     <img src="./assets/img/Ellipse 77.png" alt="">
            //     <p>Lorem ipsum dolor sit amet,
            //       consetetur sadipscing elitr, sed
            //       diam nonumy eirmod </p>
            //   </div>
            // </li>
      //php撈資料
      // axios.get("./assets/php/front/bidding_member.php").then((head) => {
      //         console.log(head.data[0].name);
      //         this.username = head.data[0].name;
      //   }).catch();
        //localstorge版本 留言板
        this.MessageData = JSON.parse(localStorage.getItem('messageList')) || [];
    },
    methods:{
      
      addmessage(){
        // console.log(this.newMessage);
        // this.messages.push(this.newMessage)
          if($.inArray(this.newMessage,this.messages)== -1){
            // this.messages.push(this.newMessage)
            this.newMessagebord={
            user:'way',
            photo:'./assets/img/Ellipse 77.png',
            messages:this.newMessage,
            }
            this.MessageData.push(this.newMessagebord);
            localStorage.setItem('messageList',JSON.stringify( this.MessageData));
          }
            this.newMessage = '';



        }
    },

  });
    Vue.component('my-component1',{
    template:`
    <div class="content">
      <div class="biddinform">
      <ul class="biddtop">
        <li>時間</li>
        <li>競標者</li>
        <li>價錢</li>
      </ul>
      <table class="biddcontent">
        <tr v-for="item in oldBiddList">
            <td>{{item.bidding_time}}</td>
            <td>{{item.member_id}}</td>
            <td>{{item.bidding_price}}</td>
        </tr>
    </table>
      </div>
    </div>
    `,
    // localstorge 競標紀錄
    // <tr v-for="item in currentBiddList">
    //         <td>{{item.time}}</td>
    //         <td>{{item.person}}</td>
    //         <td>{{item.price}}</td>
    //     </tr>
    props:['list'],
    data(){
      return{
        componentChange:'',
        oldBiddList:[],
        newObj:this.list,
        // currentBiddList:this.list,     //localstorge版本 競標紀錄
      }
    },
    mounted() {
      this.$emit('component_change',1)
      //localstorge版本 競標紀錄
      // this.oldBiddList = JSON.parse(localStorage.getItem('biddList')) || [];
    },
    updated() {
        this.newobj_two();
    },
    methods:{
      newobj_two(){
        setInterval(()=>{
          this.oldBiddList = this.list;
        },1000)
        
      },
    },
    watch: {
        list: {
          handler() {
            this.newobj_two();
          },
          immediate:true,
          deep: true,
        },
      },
  });
  
    new Vue({
      el:'#app_bidd',
      data:{
          componentChange:0,
          username:'',
          active:0,
          nowTime:'',
          imgList:[],
          dataId:[],
          newObj:[
          // {bidding_time:""},
          // {member_id:""},
          // {bidding_price:''},
          ],
          NameList:[],
          Introduce:[],
          SpriceList:[],
          NpriceList:[],
          biddList:[],
          ExhibitName:'',
          ExhibitIntro:'',
          Sprice:null,
          Nprice:null,
          inputprice:null,
          // nowBidding:{
          //   price:null,
          //   person:"",
          //   time:'',
          // },
          nowBidding:[],
          biddverify:[],
          theId: '1',
          content:'my-component',
          itemMessage:'尚未選取競標品',
          timer:OneHour,
          itemTime:'尚未選取競標品',
          timeList:[],
          headshot:"./assets/img/Ellipse 77.png",
          imgSrc:'./assets/img/exh_5.jpg',
          price: 888,
      },
      filters: {
          hoursMinutesAndSeconds (value) {
          // let hours = Math.floor(value / 60 * 60);
          let hours = Math.floor(value / (60 * 60));
          let minutes = Math.floor((value / 60) % 60);
	        let seconds = Math.floor(value % 60);
          return `${hours} : ${minutes} : ${seconds}`;
        }
      },
      // 抓資料
      mounted() {
        axios.get("./assets/php/front/bidding.php").then((res) => {
              console.log(res.data);
              for(let i = 0; i<=res.data.length;i++){
                this.imgList.push(res.data[i].img_path);
                this.dataId.push(res.data[i].work_id);
                this.timeList.push(res.data[i].bidding_time);
                this.NameList.push(res.data[i].work_name);
                this.Introduce.push(res.data[i].work_introduce);
                this.SpriceList.push(res.data[i].start_price);
                this.NpriceList.push(res.data[i].now_price);
                this.biddverify.push(res.data[i].bidding_verify);
                // console.log(this.imgList)
              }
        }).catch();
        // setTimeout(()=>{         
        //     this.dataId = product.dataId;
        //     this.imgList = product.imgList;
        //     this.ExhibitName = product.ExhibitName[0];
        // },500);
        //this.newObj = JSON.parse(localStorage.getItem('biddList'))||[];
        setInterval(() => this.timer -= 1, 1000);
      },
      methods: {

        changeHandler(val){
          // console.log(val);
          this.componentChange = val;
        },
        change(index){
                    this.active = (index + this.total) % this.total
                },
        getData(e){
              this.theId = e.target.dataset.id - 1;   
              // this.imgSrc = `./assets/img/${this.theId}.png`;
              // this.imgSrc = `./assets/img/exh_${this.theId}.jpg`;
              this.imgSrc = this.imgList[this.theId];
              this.ExhibitName = this.NameList[this.theId];
              this.ExhibitIntro = this.Introduce[this.theId];
              this.Sprice = this.SpriceList[this.theId]*1;
              this.Nprice = this.NpriceList[this.theId];
              this.inputprice = this.Sprice;
              this.itemTime = this.timeList[this.theId];
              let nowStatus ;
              //他可不可以競標
              //如果他可以競標我再每秒刷新
              // setInterval(() => this.Getbiddlist(), 1000);
              ///////
              for(let status in this.biddverify){
                // console.log(status);
                // nowStatus = this.biddverify[status];
              // if(this.biddverify[status] == '1' && (this.theId-1) == status){
              if(this.biddverify[status] == '1' && (this.theId) == status){

            
                this.itemMessage = '競標中';
                return
              }else{
                // console.log(2);
                this.itemMessage = '尚未競標';
                this.itemTime = this.timeList[this.theId];
              }}
              // let biddid = this.biddverify[this.theId];
              // if(biddid = "1"){
              //   this.itemMessage = '競標中'
              // }else{
              //   this.itemMessage = '尚未競標'
              // }
              
        },
        Getbiddlist(){
          // console.log(this.theId);
          this.newObj = {
                  bidding_time:'',
                  member_id:'',
                  bidding_price:null,
                };
          axios.post('./assets/php/front/biddingpost.php',{'work_id':this.theId})
              .then((res) => { //console.log(res.data);
                this.newObj = res.data
                this.Nprice = res.data[0].bidding_price;
                // console.log(this.newObj)
                //  this.newObj.push(res.data[0]); 
          }).catch();
        },
        addLocal(){
          // local版 假資料
          this.nowBidding={
            price:this.inputprice,
            //person:'Andy',
            time:this.timeFormate,
            work_id:this.theId
          };
          
            if(this.inputprice>this.Nprice)
            {
              // local版本 代資料 
              // this.newObj.push(this.nowBidding);              
              // localStorage.setItem('biddList',JSON.stringify(this.newObj));
              // 資料由php帶入
              axios.post('./assets/php/front/biddingpost.php', this.nowBidding)
              .then((res) => { 
                console.log(res.data[0])
                this.nowBidding={
                  price:res.data[0].bidding_price,
                  person:res.data[0].work_id,
                  time:res.data[0].bidding_time
                }
              })
              //.catch((error) => { console.error(error) })
            }else{
              alert('出價須高於目前價格')
            }
              console.log(this.nowBidding);
              console.log(res.data);
              

        },},
      computed:{
        total(){
                return this.imgList.length
              },
                 // 得到當下時間
        timeFormate() {
        let newdate = new Date();
        let hh    = newdate.getHours() < 10? "0" + newdate.getHours(): newdate.getHours();
        let mm    = newdate.getMinutes() < 10? "0" + newdate.getMinutes(): newdate.getMinutes();
        let ss    = newdate.getSeconds() < 10? "0" + newdate.getSeconds(): newdate.getSeconds();
        this.nowTime = hh.toString()+":"+mm.toString() + ":" + ss.toString();
        return this.nowTime
        },
      },
      // watch:{
      //   count:function(val){
      //       this.type = typeof val;
      //   },
      // },
    });
  </script>
  <!-- Swiper JS -->
  <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
  <script>
    var swiper = new Swiper('.swiper-container', {
      slidesPerView: 4,
      centeredSlides: false,
      spaceBetween: 0,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
    });
    
  </script>
</body>
<!-- <script src="./assets/js/search_all.js"></script> -->
<script src="./assets/js/menu.js"></script>
<script src="./assets/js/loginFB.js"></script>
<script src="./assets/js/loginGoogle.js"></script>
<script src='./assets/js/music.js'></script>
<script src='./assets/js/verify.js'></script>
<script src='./assets/js/logIn.js'></script>
</html>